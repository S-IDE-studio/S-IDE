name: Mobile Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      build_mode:
        description: "What to build"
        required: true
        default: "debug-apk"
        type: choice
        options:
          - debug-apk
          - eas-android
          - eas-ios
      eas_profile:
        description: "EAS build profile (only for EAS builds)"
        required: true
        default: "preview"
        type: choice
        options:
          - production
          - preview
          - development

permissions:
  contents: write

jobs:
  build-android-debug-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    # Debug APK is useful for quick installs, but we don't ship it on tag releases.
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.build_mode == 'debug-apk'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Prebuild Android (Expo)
        working-directory: apps/mobile
        env:
          CI: "1"
        run: pnpm -F side-mobile exec expo prebuild -p android --no-install

      - name: Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('apps/mobile/android/**/*.gradle*', 'apps/mobile/android/**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build Debug APK
        working-directory: apps/mobile/android
        run: |
          chmod +x ./gradlew
          ./gradlew assembleDebug --no-daemon

      - name: Prepare APK artifact
        id: prep
        run: |
          VERSION="${GITHUB_REF_NAME:-dev}"
          mkdir -p dist/mobile
          APK_PATH=$(ls apps/mobile/android/app/build/outputs/apk/debug/*.apk | head -n 1)
          OUT="dist/mobile/s-ide-${VERSION}-android-debug.apk"
          cp "$APK_PATH" "$OUT"
          echo "apk_path=$OUT" >> "$GITHUB_OUTPUT"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-debug-apk
          path: ${{ steps.prep.outputs.apk_path }}
          if-no-files-found: error

      - name: Upload APK to GitHub Release (tag only)
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.prep.outputs.apk_path }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  eas-android:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    # Run on tag pushes (production), or on manual dispatch for eas-android mode.
    if: (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_mode == 'eas-android')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: EAS Build (Android)
        id: build
        working-directory: apps/mobile
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EAS_PROFILE: ${{ github.event.inputs.eas_profile }}
        run: |
          set -euo pipefail
          if [ -z "${EXPO_TOKEN:-}" ]; then
            echo "EXPO_TOKEN is not configured in GitHub Secrets."
            echo "Add it at: Settings -> Secrets and variables -> Actions -> New repository secret (EXPO_TOKEN)"
            exit 1
          fi

          PROFILE="${EAS_PROFILE:-preview}"
          if [[ "${GITHUB_REF:-}" == refs/tags/* ]]; then
            PROFILE="production"
          fi

          npm install -g eas-cli
          eas --version

          echo "Starting EAS Android build (profile=$PROFILE)..."
          eas build --platform android --profile "$PROFILE" --non-interactive --wait

          echo "Finding finished build for this commit..."
          eas build:list --platform android --status finished --limit 1 --git-commit-hash "$GITHUB_SHA" --json --non-interactive > builds.json
          BUILD_ID="$(node -e "const fs=require('fs'); const j=JSON.parse(fs.readFileSync('builds.json','utf8')); const b=Array.isArray(j)?j[0]:(j.builds?j.builds[0]:j); process.stdout.write(String((b&&b.id)||''));")"
          if [ -z "$BUILD_ID" ]; then
            echo "Failed to resolve Android build id from builds.json"
            cat builds.json
            exit 1
          fi
          echo "build_id=$BUILD_ID" >> "$GITHUB_OUTPUT"

          echo "Fetching build details..."
          eas build:view "$BUILD_ID" --json > build.json
          URL="$(node -e "const fs=require('fs'); const j=JSON.parse(fs.readFileSync('build.json','utf8')); const a=j.artifacts||j.build?.artifacts||{}; const c=[a.buildUrl,a.applicationArchiveUrl,a.applicationArchiveBuildUrl,a.aabUrl,a.apkUrl,j.buildUrl].filter(x=>typeof x==='string'&&x.length>0); process.stdout.write(c[0]||'');")"
          if [ -z "$URL" ]; then
            echo "Could not find an artifact URL in build.json"
            cat build.json
            exit 1
          fi

          VERSION="${GITHUB_REF_NAME:-dev}"
          FILE="${URL##*/}"
          FILE="${FILE%%\?*}"
          EXT="aab"
          if [[ "$FILE" == *.apk ]]; then EXT="apk"; fi
          if [[ "$FILE" == *.aab ]]; then EXT="aab"; fi

          mkdir -p "$GITHUB_WORKSPACE/dist/mobile"
          OUT="$GITHUB_WORKSPACE/dist/mobile/s-ide-${VERSION}-android.${EXT}"
          echo "Downloading $URL -> $OUT"
          curl -L "$URL" -o "$OUT"
          echo "artifact_path=dist/mobile/s-ide-${VERSION}-android.${EXT}" >> "$GITHUB_OUTPUT"

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: ${{ steps.build.outputs.artifact_path }}
          if-no-files-found: error

      - name: Upload Android artifact to GitHub Release (tag only)
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.build.outputs.artifact_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  eas-ios:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    # Run on tag pushes, or on manual dispatch for eas-ios mode.
    # Note: we intentionally do not reference `secrets.*` in `if:` because it can make the workflow invalid.
    if: (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_mode == 'eas-ios')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: EAS Build (iOS)
        id: build
        working-directory: apps/mobile
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EAS_PROFILE: ${{ github.event.inputs.eas_profile }}
        run: |
          set -euo pipefail
          if [ -z "${EXPO_TOKEN:-}" ]; then
            echo "EXPO_TOKEN is not configured in GitHub Secrets."
            echo "Add it at: Settings -> Secrets and variables -> Actions -> New repository secret (EXPO_TOKEN)"
            exit 1
          fi

          PROFILE="${EAS_PROFILE:-preview}"
          npm install -g eas-cli
          eas --version

          echo "Starting EAS iOS build (profile=$PROFILE)..."
          eas build --platform ios --profile "$PROFILE" --non-interactive --wait

          echo "Finding finished build for this commit..."
          eas build:list --platform ios --status finished --limit 1 --git-commit-hash "$GITHUB_SHA" --json --non-interactive > builds.json
          BUILD_ID="$(node -e "const fs=require('fs'); const j=JSON.parse(fs.readFileSync('builds.json','utf8')); const b=Array.isArray(j)?j[0]:(j.builds?j.builds[0]:j); process.stdout.write(String((b&&b.id)||''));")"
          if [ -z "$BUILD_ID" ]; then
            echo "Failed to resolve iOS build id from builds.json"
            cat builds.json
            exit 1
          fi
          echo "build_id=$BUILD_ID" >> "$GITHUB_OUTPUT"

          echo "Fetching build details..."
          eas build:view "$BUILD_ID" --json > build.json
          URL="$(node -e "const fs=require('fs'); const j=JSON.parse(fs.readFileSync('build.json','utf8')); const a=j.artifacts||j.build?.artifacts||{}; const c=[a.buildUrl,a.applicationArchiveUrl,a.applicationArchiveBuildUrl,a.ipaUrl,j.buildUrl].filter(x=>typeof x==='string'&&x.length>0); process.stdout.write(c[0]||'');")"
          if [ -z "$URL" ]; then
            echo "Could not find an artifact URL in build.json"
            cat build.json
            exit 1
          fi

          VERSION="${GITHUB_REF_NAME:-dev}"
          FILE="${URL##*/}"
          FILE="${FILE%%\?*}"
          EXT="ipa"
          if [[ "$FILE" == *.tar.gz ]]; then EXT="tar.gz"; fi

          mkdir -p "$GITHUB_WORKSPACE/dist/mobile"
          OUT="$GITHUB_WORKSPACE/dist/mobile/s-ide-${VERSION}-ios.${EXT}"
          echo "Downloading $URL -> $OUT"
          curl -L "$URL" -o "$OUT"
          echo "artifact_path=dist/mobile/s-ide-${VERSION}-ios.${EXT}" >> "$GITHUB_OUTPUT"

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: ${{ steps.build.outputs.artifact_path }}
          if-no-files-found: error

      - name: Upload iOS artifact to GitHub Release (tag only)
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.build.outputs.artifact_path }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
